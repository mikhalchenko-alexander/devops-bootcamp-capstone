def gv
def JAVA_APP_DIR = "project3/java-app"
def TERRAFORM_DIR = "project3/terraform"
def IMAGE_NAME = "aam123/java-app:capstone3"

pipeline {
    agent any
    parameters {
        choice(name: 'ACTION', choices: ['deploy', 'destroy'], description: 'Choose to deploy the application or destroy the infrastructure')
    }
    tools {
        maven 'Maven'
    }
    stages {
        stage("init") {
            steps {
                script {
                    dir(JAVA_APP_DIR) {
                        gv = load "script.groovy"
                    }
                }
            }
        }
        stage("build jar") {
            when {
                expression { params.ACTION == 'deploy' }
            }
            steps {
                script {
                    dir(JAVA_APP_DIR) {
                        gv.buildJar()
                    }
                }
            }
        }

        stage("build image") {
            when {
                expression { params.ACTION == 'deploy' }
            }
            steps {
                script {
                    dir(JAVA_APP_DIR) {
                        gv.buildImage(IMAGE_NAME)
                    }
                }
            }
        }

        stage("provision server") {
              when {
                  expression { params.ACTION == 'deploy' }
              }
              environment {
                    AWS_ACCESS_KEY_ID = credentials('jenkins_aws_access_key_id')
                    AWS_SECRET_ACCESS_KEY = credentials('jenkins_aws_secret_access_key')
              }
              steps {
                    script {
                          dir(TERRAFORM_DIR) {
                                sh "terraform init"
                                sh "terraform apply --auto-approve"
                                EC2_PUBLIC_IP = sh(
                                  script: "terraform output ec2-public_ip",
                                  returnStdout: true
                                ).trim()
                          }
                    }
              }
            }

        stage("destroy infrastructure") {
              when {
                  expression { params.ACTION == 'destroy' }
              }
              environment {
                    AWS_ACCESS_KEY_ID = credentials('jenkins_aws_access_key_id')
                    AWS_SECRET_ACCESS_KEY = credentials('jenkins_aws_secret_access_key')
              }
              steps {
                    script {
                          dir(TERRAFORM_DIR) {
                                sh "terraform init"
                                sh "terraform destroy --auto-approve"
                          }
                    }
              }
            }


        stage("deploy") {
              when {
                  expression { params.ACTION == 'deploy' }
              }
              environment {
                    DOCKER_CREDS = credentials('docker-hub-repo')
              }
              steps {
                  script {
                      dir(JAVA_APP_DIR) {
                          echo "waiting for EC2 server to initialize"
                          sleep(time: 90, unit: "SECONDS")

                          echo 'deploying docker image to EC2...'
                          echo "${EC2_PUBLIC_IP}"

                          def shellCmd = "bash ./server-cmds.sh ${IMAGE_NAME} ${DOCKER_CREDS_USR} ${DOCKER_CREDS_PSW}"
                          def ec2Instance = "ec2-user@${EC2_PUBLIC_IP}"

                          sshagent(['dev-ops-bootcamp']) {
                              sh "scp -o StrictHostKeyChecking=no server-cmds.sh ${ec2Instance}:/home/ec2-user"
                              sh "scp -o StrictHostKeyChecking=no docker-compose.yml ${ec2Instance}:/home/ec2-user"
                              sh "ssh -o StrictHostKeyChecking=no ${ec2Instance} ${shellCmd}"
                          }
                      }
                  }
              }
        }
    }
}
